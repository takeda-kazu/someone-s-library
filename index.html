<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="個人の本棚管理システム - 読書記録と感想を保存・共有"
    />
    <meta name="theme-color" content="#000000" />
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.gstatic.com https://udify.app https://*.udify.app https://cdnjs.cloudflare.com https://googletagmanager.com https://www.googletagmanager.com https://analytics.google.com https://api.github.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https: http:; font-src 'self' data:; connect-src 'self' https://www.gstatic.com https://firebasestorage.googleapis.com https://firestore.googleapis.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://udify.app https://*.udify.app https://googletagmanager.com https://www.googletagmanager.com https://analytics.google.com https://api.github.com; frame-src 'self' https://udify.app https://*.udify.app; media-src 'self' https://udify.app https://*.udify.app;">
    <title>〇〇本棚 - Library Watch</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <link rel="stylesheet" href="styles.css" />

    <!-- GZIP圧縮ライブラリ (Dify inputs エンコード用) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js" integrity="sha512-g2TeAWw5GPnX56pwUYgbo1ksz7RGvCV6/Ysla2cLK1fmMySTn7aa1Y2VH39R0LV1AVK1joOZP8SbBG5YMkMXuQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- Firebase SDK -->
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
      import {
        getAuth,
        signInWithEmailAndPassword,
        signOut,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
      import {
        getFirestore,
        collection,
        doc,
        addDoc,
        setDoc,
        updateDoc,
        deleteDoc,
        getDocs,
        query,
        orderBy,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyBs8q4LIEnYpqk_PzaJwZO7I7C9gWu6MIk",
        authDomain: "library-6632c.firebaseapp.com",
        projectId: "library-6632c",
        storageBucket: "library-6632c.firebasestorage.app",
        messagingSenderId: "475019124517",
        appId: "1:475019124517:web:69e3e6d5d81467a61944cc",
        measurementId: "G-8GWPSS67D1",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // グローバル変数として設定
      window.firebaseApp = app;
      window.firebaseAuth = auth;
      window.firebaseDb = db;

      // Firestore関数もグローバルに公開
      window.firestore = {
        collection,
        doc,
        addDoc,
        setDoc,
        updateDoc,
        deleteDoc,
        getDocs,
        getDoc,
        query,
        orderBy,
      };

      // Firebase Auth関数もグローバルに公開
      window.firebaseAuthFunctions = {
        signInWithEmailAndPassword,
        signOut,
        onAuthStateChanged,
      };

      console.log("Firebase initialized successfully");
    </script>

    <script src="books-data.js"></script>
    <script src="app.js"></script>
  </head>
  <body>
    <!-- 背景エフェクト用要素 -->
    <div class="ambient-background"></div>

    <!-- ヘッダー: アプリのタイトルとナビゲーション -->
    <header id="app-header" role="banner" class="glass-header">
      <div class="header-content">
        <h1 id="app-title">
          <span class="visually-hidden">私の</span>
          Library Watch
        </h1>
        <!-- Aboutボタン -->
        <a href="about.html" class="icon-button" aria-label="About" title="About">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
        </a>
        <!-- 管理モード切り替えボタン -->
        <nav class="admin-controls" aria-label="管理モード切り替え">
          <button
            id="admin-mode-btn"
            class="icon-button"
            aria-label="管理モードに切り替え"
            type="button"
            title="管理モード"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
          </button>
          <button
            id="normal-mode-btn"
            class="icon-button active"
            style="display: none"
            aria-label="通常モードに切り替え"
            type="button"
            title="通常モード"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
          </button>
        </nav>
      </div>
    </header>

    <!-- メインコンテナ -->
    <main id="main-content" role="main" class="main-container">
      <!-- SC1: 一覧画面 -->
      <section
        id="screen-list"
        class="screen fade-in"
        aria-labelledby="book-list-heading"
      >
        <h2 id="book-list-heading" class="visually-hidden">本の一覧</h2>

        <!-- 検索・フィルター機能（管理モード時のみ表示） -->
        <div
          id="search-controls"
          class="search-controls glass-panel"
          style="display: none"
          role="search"
          aria-label="本を検索"
        >
          <div class="search-input-wrapper">
             <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            <input
              type="search"
              id="search-input"
              placeholder="検索"
              class="search-input"
              aria-describedby="search-hint"
            />
          </div>
          <span id="search-hint" class="visually-hidden"
            >タイトルまたは著者名で検索できます</span
          >

          <div class="filter-actions">
            <select
              id="author-filter"
              class="author-filter"
              aria-label="著者で絞り込み"
            >
              <option value="">すべての著者</option>
            </select>

            <button
              id="add-book-btn"
              class="primary-button"
              type="button"
              aria-label="新しい本を追加"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
              新規追加
            </button>
          </div>
        </div>

        <div
          id="book-list"
          class="book-grid"
          role="list"
          aria-live="polite"
          aria-atomic="false"
        ></div>
      </section>

      <!-- SC2: 詳細画面 -->
      <section
        id="screen-detail"
        class="screen"
        style="display: none"
        aria-labelledby="detail-heading"
      >
        <div class="detail-header">
            <button
              id="back-btn"
              class="back-link"
              type="button"
              aria-label="一覧に戻る"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
              戻る
            </button>
        </div>
        
        <div id="book-detail-content" role="article" class="detail-content glass-panel">
          <!-- ここに本の詳細が動的に表示されます -->
        </div>
      </section>

      <!-- SC3: 追加・編集画面（管理モード時のみ表示） -->
      <section
        id="screen-edit"
        class="screen"
        style="display: none"
        aria-labelledby="edit-heading"
      >
        <div class="detail-header">
            <button
              id="back-edit-btn"
              class="back-link"
              type="button"
              aria-label="一覧に戻る"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
              キャンセル
            </button>
        </div>
        <div id="book-edit-content" class="edit-content glass-panel">
          <!-- ここに本の追加・編集フォームが動的に表示されます -->
        </div>
      </section>
    </main>

    <!-- 認証モーダル -->
    <div
      id="auth-modal"
      class="modal"
      style="display: none"
      role="dialog"
      aria-modal="true"
      aria-labelledby="auth-modal-title"
    >
      <div class="modal-overlay" aria-hidden="true"></div>
      <div class="modal-content glass-modal">
        <div class="modal-header">
          <h2 id="auth-modal-title">管理モード</h2>
          <button
            id="close-auth-modal-x"
            class="close-icon-btn"
            type="button"
            aria-label="認証モーダルを閉じる"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
          </button>
        </div>
        <form class="auth-form" onsubmit="return false;">
          <div class="input-group">
              <label for="auth-email" class="visually-hidden">メールアドレス</label>
              <input
                type="email"
                id="auth-email"
                placeholder="メールアドレス"
                class="modern-input"
                required
                autocomplete="email"
                aria-required="true"
              />
          </div>

          <div class="input-group">
              <label for="auth-password" class="visually-hidden">パスワード</label>
              <input
                type="password"
                id="auth-password"
                placeholder="パスワード"
                class="modern-input"
                required
                autocomplete="current-password"
                aria-required="true"
              />
          </div>

          <button
            id="auth-login-btn"
            class="primary-button full-width"
            type="submit"
            aria-label="ログイン"
          >
            ログイン
          </button>
        </form>
      </div>
    </div>



    <!-- 閲覧パスワードモーダル -->
    <div
      id="view-password-modal"
      class="modal"
      style="display: none"
      role="dialog"
      aria-modal="true"
      aria-labelledby="view-password-title"
    >
      <div class="modal-overlay" aria-hidden="true"></div>
      <div class="modal-content glass-modal">
        <div class="modal-header">
          <h2 id="view-password-title">パスワード入力</h2>
        </div>
        <form
          class="auth-form"
          id="view-password-form"
          onsubmit="return false;"
        >
          <div class="input-group">
              <input
                type="password"
                id="view-password-input"
                placeholder="パスワード"
                class="modern-input"
                required
                autocomplete="off"
                aria-required="true"
              />
          </div>
          <div
            id="view-password-error"
            class="error-message"
            style="display: none"
          >
            パスワードが正しくありません
          </div>
          <button
            id="view-password-btn"
            class="primary-button full-width"
            type="submit"
            aria-label="パスワードを確認"
          >
            確認
          </button>
        </form>
      </div>
    </div>

    <!-- AIチャットモーダル -->
    <div
      id="chat-modal"
      class="modal chat-modal"
      style="display: none"
      role="dialog"
      aria-modal="true"
      aria-labelledby="chat-modal-title"
    >
      <div class="modal-overlay" aria-hidden="true"></div>
      <div class="modal-content chat-modal-content glass-modal">
        <div class="modal-header">
          <div class="chat-header-info">
            <h2 id="chat-modal-title">AI読書パートナー</h2>
            <p id="chat-modal-book-title" class="chat-book-title">本を選択中...</p>
          </div>
          <button
            id="close-chat-modal-x"
            class="close-icon-btn"
            type="button"
            aria-label="チャットを閉じる"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
          </button>
        </div>
        <div class="chat-container">
          <iframe
            id="dify-chatbot-iframe"
            src=""
            title="Dify Chatbot"
            allow="microphone"
          >
          </iframe>
        </div>
        <div class="modal-footer">
           <button id="chat-copy-info-btn" class="secondary-button" type="button">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
             本の情報をコピー
          </button>
        </div>
      </div>
    </div>

    <!-- Status messages for screen reader announcements -->
    <div
      role="status"
      aria-live="polite"
      aria-atomic="true"
      class="visually-hidden"
      id="status-message"
    ></div>

    <!-- ローディングインジケーター -->
    <div
      id="loading-indicator"
      class="loading-overlay"
      style="display: none"
      role="status"
      aria-live="polite"
    >
      <div class="loading-spinner">
        <div class="spinner-blade"></div>
        <div class="spinner-blade"></div>
        <div class="spinner-blade"></div>
        <div class="spinner-blade"></div>
        <div class="spinner-blade"></div>
        <div class="spinner-blade"></div>
        <div class="spinner-blade"></div>
        <div class="spinner-blade"></div>
        <div class="spinner-blade"></div>
        <div class="spinner-blade"></div>
        <div class="spinner-blade"></div>
        <div class="spinner-blade"></div>
      </div>
    </div>

    <!-- トースト通知コンテナ -->
    <div
      id="toast-container"
      class="toast-container"
      aria-live="polite"
      aria-atomic="true"
    ></div>
  </body>
</html>
